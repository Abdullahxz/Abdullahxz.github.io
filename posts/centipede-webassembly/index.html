<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title>
         Running an OpenGL game with WebAssembly
        
    </title><meta content="Running an OpenGL game with WebAssembly" property=og:title><link href=/icon/favicon.ico rel=icon type=image/png><link href=https://abdullahxz.github.io/fonts.css rel=stylesheet><script>(()=>{var a=document.createElement(`script`);a.setAttribute(`src`,`/js/imamu.js`);a.setAttribute(`data-website-id`,`6df23ebd-7d64-43e6-bab9-d5a5f9a1eb79`);a.setAttribute(`data-host-url`,`https:&#x2F;&#x2F;analytics.eu.umami.is`);document.body.appendChild(a)})()</script><script async data-host-url=https://analytics.eu.umami.is data-website-id=6df23ebd-7d64-43e6-bab9-d5a5f9a1eb79 src=/js/imamu.js></script><script async data-goatcounter=https://abdullahxz.goatcounter.com/count src=https://abdullahxz.github.io/js/count.js></script><noscript><img src="https://abdullahxz.goatcounter.com//count?p=/posts/centipede-webassembly/&t=Running an OpenGL game with WebAssembly"></noscript><link href=https://abdullahxz.github.io/atom.xml rel=alternate title=Abdullahxz type=application/atom+xml><link href=https://abdullahxz.github.io/theme/light.css rel=stylesheet><link href=https://abdullahxz.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://abdullahxz.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme())</script><link href=https://abdullahxz.github.io/main.css media=screen rel=stylesheet><body><div class=content><header><div class=main><a href=https://abdullahxz.github.io>Abdullahxz</a><div class=socials><a class=social href=https://github.com/Abdullahxz/ rel=me> <img alt=github src=https://abdullahxz.github.io/social_icons/github.svg> </a></div></div><nav><a href=https://abdullahxz.github.io/posts style=margin-left:.5em>/posts</a><a href=https://abdullahxz.github.io/tags style=margin-left:.5em>/tags</a><a href=https://abdullahxz.github.io/projects style=margin-left:.5em>/projects</a><a href=https://abdullahxz.github.io/about style=margin-left:.5em>/about</a> |<a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://abdullahxz.github.io/feather/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://abdullahxz.github.io/feather/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><main><article><div class=title><div class=page-header>Running an OpenGL game with WebAssembly<span class=primary-color style=font-size:1.6em>.</span></div><div class=meta>Posted on <time>2024-09-21</time><span class=tags-label> :: Tags:</span><span class=tags> <a class=post-tag href=https://abdullahxz.github.io/tags/wasm/>wasm</a> </span></div></div><section class=body><style>main img{margin-left:auto;margin-right:auto;display:block}</style><h1 id=what-even-is-webassembly>What even is WebAssembly?</h1><p>WebAssembly introduces huge implications for what's possible on the web platform, it's a binary instruction format optimized for fast execution, allowing code written in languages like C, C++, and Rust to run with near-native speed in the browser. By operating as a low-level virtual machine, WebAssembly executes tasks in a manner similar to how native applications do, but within the web's security sandbox. This makes it possible to run performance intensive applications, such as video games, computer vision, virtual and augmented reality, and realtime data intensive visualizations, directly in the browser. Each of the major browsers have their own wasm runtime to support these kind of applications.<h1 id=why-should-you-care>Why should you care?</h1><p>Beyond just the browser environment, WebAssembly opens up a wide range of applications including microservices, serverless, 3rd party plugin systems, databases, analytics, and event streaming, among others. Its lower start-up time than other similar technologies, such as JS isolates and containers along with being sandboxed-by-default and also the fact that it runs at near native speed are some of the reasons for a wide range of use cases. If you have previous experience getting bottlenecked by JavaScript's performance in browsers, WebAssembly is a welcome addition to the web ecosystem. I have had my MacBook Pro give up when working with data intensive visualizations in <a href=https://www.datadoghq.com/ rel=noopener target=_blank>DataDog</a> or when playing with Shaders in <a href=https://www.shadertoy.com/ rel=noopener target=_blank>ShaderToy</a>. I've also read about how JavaScript was like pre JIT compilation but back then it was the only option if you wanted to run code in browser to interact with the web page. You can think of WebAssembly as a new programming language which is much faster than JavaScript and can run in browsers as well. This does not mean that WebAssembly is intended to replace JavaScript, it's designed to work alongside JS which makes it possible to combine WebAssembly’s speed with JavaScript's flexibility. Most of the adoptions which we will see will not be full WebAssembly codebases, but both JS and WebAssmbly being used in a single application complementing each other. If interested, you can read about these use cases in detail, <a href="https://bytecodealliance.org/articles/wasmtime-1-0-fast-safe-and-production-ready?ref=abdullahxz.github.io" rel=noopener target=_blank>here</a>.<h1 id=getting-hands-dirty>Getting Hands Dirty</h1><p>I've been looking at WebAssembly for years now (wrote one hello world program years ago) and only very recently decided to dive deeper with an interesting enough project to fuel my weekends. Centipede is a vertically oriented fixed shooter arcade game produced by Atari, Inc. in June 1981. The game was designed by Dona Bailey and Ed Logg. The player fights off centipedes, spiders, scorpions, and ants, completing a round after eliminating the centipede that winds down the playing field. It was one of our semester projects in university and just the right fit for this project.<p><img alt src=https://abdullahxz.github.io/posts/centipede-webassembly/./static/centipede.gif><h2 id=compiler-toolchain>Compiler toolchain</h2><p>We'll be using Emscripten to compile the centipede program into WebAssembly. It's an open source compiler toolchain using <code>emcc</code> as a frontend and <code>Clang</code> and <code>LLVM</code> as backend. Besides that, Emscripten can also generate the "glue" JavaScript and HTML code which comes in handy especially in an experimental project like this one. This is needed to handle memory allocation, memory leaks, and a host of other problems such as for now, WebAssembly cannot currently directly access the DOM, it can only call JavaScript, passing in integer and floating point primitive data types. Thus, to access any Web API, WebAssembly needs to call out to JavaScript, which then makes the Web API call.<p><img alt src=https://abdullahxz.github.io/posts/centipede-webassembly/./static/emscripten.png><p>Once the HTML & JS code and WASM modules are ready we can use any http server to serve them. Just like HTML and JS, browser downloads the wasm module. Then, it can make the short hop from WebAssembly to that target machine’s assembly code (x86 or ARM).<p>Before we go forward with the port there are some things we need to take care of such as to modify file handling to adapt to the limitations of the browser/JavaScript. The support for legacy OpenGL features and commands is also not great so going into this I was not expecting a flawless 1:1 port. I expected to make significant modifications to my program to address these limitations. However, as we’ll see during the porting process, the adjustments required are minimal. In fact, the only changes I needed to make involved commenting out or swapping a few unsupported OpenGL functions in Emscripten.<h2 id=okay-here-it-goes>Okay, Here it Goes</h2><p>For the port itself, all that is needed is using <code>em++</code> as a drop in replacement for <code>g++</code>. There are also a handful of linker flags which are needed to enable support for legacy GL features and other performance optimizations, some of them being<ul><li>LEGACY_GL_EMULATION <ul><li>Enables legacy GL support.</ul><li>GL_UNSAFE_OPTS <ul><li>Enables some potentially-unsafe optimizations in GL emulation code by attempting to skip redundant GL work and cleanup. It is enabled by default but we set this to false.</ul><li>STACK_SIZE <ul><li>The total stack size. There is no way to enlarge the stack, so this value must be large enough for the program’s requirements. Setting this to a lower value than your program needs will cause it to crash.</ul><li>EXIT_RUNTIME <ul><li>By default Emscripten does not include code to shut down the runtime. Building with EXIT_RUNTIME will include the code to do so.</ul><li>-o game.html <ul><li>Specifies that we want Emscripten to generate an HTML page to run our code in and the filename to use, as well as the Wasm module and the JavaScript glue code to compile and instantiate the Wasm so it can be used in the web environment.</ul></ul><h3 id=legacy-leagacy-legacy>Legacy Leagacy Legacy</h3><p>The first time I ran the project in web turned out to be a bit of let-down. There were no mushrooms on the screen and the browser's console was overflowing with errors.<p><img alt src=https://abdullahxz.github.io/posts/centipede-webassembly/./static/wasm-no-mushrooms.png><p>The faulty code was the following Torus2d function which was being used to draw the Mushroom's hat.<pre class=language-cpp data-lang=cpp style=color:#61676c;background-color:#fafafa><code class=language-cpp data-lang=cpp><span style=color:#fa6e32>void </span><span style=color:#f29718>Torus2d</span><span>(</span><span style=color:#fa6e32>int </span><span style=color:#ff8f40>x</span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>int </span><span style=color:#ff8f40>y</span><span style=color:#61676ccc>,
</span><span>	</span><span style=color:#fa6e32>float </span><span style=color:#ff8f40>angle</span><span style=color:#61676ccc>,
</span><span>	</span><span style=color:#fa6e32>float </span><span style=color:#ff8f40>length</span><span style=color:#61676ccc>,
</span><span>	</span><span style=color:#fa6e32>float </span><span style=color:#ff8f40>radius</span><span style=color:#61676ccc>,
</span><span>	</span><span style=color:#fa6e32>float </span><span style=color:#ff8f40>width</span><span style=color:#61676ccc>,
</span><span>	</span><span style=color:#fa6e32>unsigned int </span><span style=color:#ff8f40>samples</span><span style=color:#61676ccc>,
</span><span>	</span><span style=color:#fa6e32>float </span><span style=color:#ed9366>*</span><span style=color:#ff8f40>color</span><span>) {
</span><span>	angle </span><span style=color:#ed9366>= </span><span style=color:#f29718>Deg2Rad</span><span>(angle)</span><span style=color:#61676ccc>;
</span><span>	length </span><span style=color:#ed9366>= </span><span style=color:#f29718>Deg2Rad</span><span>(length)</span><span style=color:#61676ccc>;
</span><span>	</span><span style=color:#fa6e32>if </span><span>(color) {
</span><span>		</span><span style=color:#f29718>glColor3fv</span><span>(color)</span><span style=color:#61676ccc>;
</span><span>	}
</span><span>	</span><span style=color:#fa6e32>if </span><span>(samples </span><span style=color:#ed9366>< </span><span style=color:#ff8f40>3</span><span>)
</span><span>		samples </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>3</span><span style=color:#61676ccc>;
</span><span>	</span><span style=color:#fa6e32>const float</span><span> outer </span><span style=color:#ed9366>=</span><span> radius </span><span style=color:#ed9366>+</span><span> width</span><span style=color:#61676ccc>;
</span><span>	</span><span style=color:#f29718>glBegin</span><span>(GL_QUAD_STRIP)</span><span style=color:#61676ccc>;
</span><span>	</span><span style=color:#fa6e32>for </span><span>(</span><span style=color:#fa6e32>unsigned int</span><span> i </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;</span><span> i </span><span style=color:#ed9366><=</span><span> samples</span><span style=color:#61676ccc>; </span><span style=color:#ed9366>++</span><span>i) {
</span><span>		</span><span style=color:#fa6e32>float</span><span> a </span><span style=color:#ed9366>=</span><span> angle </span><span style=color:#ed9366>+ </span><span>(i </span><span style=color:#ed9366>/ </span><span>(</span><span style=color:#fa6e32>float</span><span>)samples) </span><span style=color:#ed9366>*</span><span> length</span><span style=color:#61676ccc>;
</span><span>		</span><span style=color:#f29718>glVertex2f</span><span>(x </span><span style=color:#ed9366>+</span><span> radius </span><span style=color:#ed9366>* </span><span style=color:#f07171>cos</span><span>(a)</span><span style=color:#61676ccc>,</span><span> y </span><span style=color:#ed9366>+</span><span> radius </span><span style=color:#ed9366>* </span><span style=color:#f07171>sin</span><span>(a))</span><span style=color:#61676ccc>;
</span><span>		</span><span style=color:#f29718>glVertex2f</span><span>(x </span><span style=color:#ed9366>+</span><span> outer </span><span style=color:#ed9366>* </span><span style=color:#f07171>cos</span><span>(a)</span><span style=color:#61676ccc>,</span><span> y </span><span style=color:#ed9366>+</span><span> outer </span><span style=color:#ed9366>* </span><span style=color:#f07171>sin</span><span>(a))</span><span style=color:#61676ccc>;
</span><span>	}
</span><span>	</span><span style=color:#f29718>glEnd</span><span>()</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>Upon looking into this, turns out <code>GL_QUAD_STRIP</code> was the issue as it would just not run in browser. This made sense to me because I knew QUADS were no longer a primitive in OpenGL as they were deprecated in <a href=https://www.khronos.org/opengl/wiki/primitive#Quads rel=noopener target=_blank>OpenGL 3.0</a> so I swapped it with the next closest thing, a <code>GL_TRIANGLE_STRIP</code> primitive, which appears to be working well.<p><img alt src=https://abdullahxz.github.io/posts/centipede-webassembly/./static/wasm-mushrooms.png><p>If you notice closely, the score is also not getting displyed in the browser environment. Following is the C++ code to draw a string on the canvas<pre class=language-cpp data-lang=cpp style=color:#61676c;background-color:#fafafa><code class=language-cpp data-lang=cpp><span style=color:#fa6e32>void </span><span style=color:#f29718>DrawString</span><span>(</span><span style=color:#fa6e32>float </span><span style=color:#ff8f40>x</span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>float </span><span style=color:#ff8f40>y</span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>const</span><span> string</span><span style=color:#ed9366>& </span><span style=color:#ff8f40>score</span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>float </span><span style=color:#ed9366>* </span><span style=color:#ff8f40>color</span><span>) {
</span><span>	</span><span style=color:#f29718>glPushMatrix</span><span>()</span><span style=color:#61676ccc>;
</span><span>	</span><span style=color:#f29718>glLoadIdentity</span><span>()</span><span style=color:#61676ccc>;
</span><span>	</span><span style=color:#f29718>glDisable</span><span>(GL_TEXTURE_2D)</span><span style=color:#61676ccc>;
</span><span>	</span><span style=color:#f29718>glBindTexture</span><span>(GL_TEXTURE_2D</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span>)</span><span style=color:#61676ccc>;
</span><span>	GLvoid </span><span style=color:#ed9366>*</span><span>font_style </span><span style=color:#ed9366>=</span><span> GLUT_BITMAP_TIMES_ROMAN_24</span><span style=color:#61676ccc>;
</span><span>	
</span><span>    </span><span style=color:#fa6e32>if </span><span>(color)
</span><span>		</span><span style=color:#f29718>glColor3fv</span><span>(color)</span><span style=color:#61676ccc>;
</span><span>	</span><span style=color:#f29718>glRasterPos3f</span><span>(x</span><span style=color:#61676ccc>,</span><span> y</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>1</span><span>)</span><span style=color:#61676ccc>;
</span><span>	</span><span style=color:#fa6e32>for </span><span>(</span><span style=color:#fa6e32>int</span><span> i </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;</span><span> i </span><span style=color:#ed9366><</span><span> score</span><span style=color:#ed9366>.</span><span style=color:#f29718>size</span><span>()</span><span style=color:#61676ccc>;</span><span> i</span><span style=color:#ed9366>++</span><span>)
</span><span>		</span><span style=color:#f29718>glutBitmapCharacter</span><span>(font_style</span><span style=color:#61676ccc>,</span><span> score[i])</span><span style=color:#61676ccc>;
</span><span>	</span><span style=color:#f29718>glPopMatrix</span><span>()</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>The issue with this approach to draw on canvas is that it uses a lot from the deprecated fixed function pipeline of OpenGL and porting it to modern OpenGL requires extra effort which I believe is for some other weekend, maybe next. So for now I can live without seeing my single digit score on the corner of my screen.<h3 id=it-s-a-feature>It's a Feature</h3><p>Now all that remains is when the player collides with in game objects like centipede, spider or fleas the game is over and is supposed to exit, but it does not in this case. Earlier I mentioned EXIT_RUNTIME linker flag which is used to include code to exit the runtime. By default Emscripten does not include code to shut down the runtime. This means that when main() exits, it does not flush the stdio streams, or call the destructors of global C++ objects, or call atexit callbacks. This lets it emit smaller code by default, and is normally what you want on the web: even though main() exited, you may have something asynchronous happening later that you want to execute. Even when building with EXIT_RUNTIME it did not exit the runtime and asked to use <code>emscripten_force_exit</code> if we want to force a true shutdown. I, for once, did not want to call JavaScript from my C++ code so I skipped this. Now, when the player dies, it does not exit the runtime; essentially giving the player unlimited lives.<p>There you have it, a C++ program running on web!<p><img alt src=https://abdullahxz.github.io/posts/centipede-webassembly/./static/wasm-centipede.gif><h1 id=fin>Fin.</h1><p>This small project provided an excellent opportunity to refresh my understanding of WebAssembly. The technology continues to advance, with its feature set expanding to include multithreading, relaxed SIMD support, garbage collection, improved debugging infrastructure, and 64-bit addressing, among other improvements. A set of proposals could be found <a href=https://github.com/WebAssembly/proposals rel=noopener target=_blank>here</a>. I'd also like to credit Lin Clark whose work was an invaluable resource during this weekend project, she does an awesome job with <a href=https://www.code-cartoons.com/ rel=noopener target=_blank>code cartoons</a>. WebAssembly bridges the gap between native and web environments, creating new possibilities for performance-intensive, secure and scalable applications both inside and outside the browser. As the ecosystem matures, the opportunities for developers will only grow, making this a fascinating space to watch and experiment with.<p>You can find the code, <a href=https://github.com/Abdullahxz/centipede-webassembly rel=noopener target=_blank>here</a>. I also made some last minute changes so the game would look more like this when you run it.<p><img alt src=https://abdullahxz.github.io/posts/centipede-webassembly/./static/centipede-on-web.png><h1 id=sources>Sources</h1><ul><li><a href=https://developer.mozilla.org/en-US/docs/WebAssembly/Concepts rel=noopener target=_blank>Mozilla Docs</a><li><a href=https://hacks.mozilla.org/category/javascript/ rel=noopener target=_blank>Mozilla Blogs</a><li><a href=https://bytecodealliance.org/ rel=noopener target=_blank>Bytecode Alliance</a><li><a href=https://leaddev.com/community/lin-clark rel=noopener target=_blank>Lin Clark</a><li><a href=https://emscripten.org/docs/introducing_emscripten/about_emscripten.html rel=noopener target=_blank>Emscripten</a></ul></section></article></main></div>